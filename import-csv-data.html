<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV ë°ì´í„° ì¼ê´„ ì…ë ¥ - 187 ì„±ì¥ì¼€ì–´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .file-input-wrapper {
            margin-bottom: 30px;
        }
        
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 15px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        input[type="file"]:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-container {
            display: none;
            margin-top: 30px;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }
        
        .log-container {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-entry.success {
            color: #27ae60;
        }
        
        .log-entry.error {
            color: #e74c3c;
            background: #ffebee;
        }
        
        .log-entry.info {
            color: #3498db;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ì—°ì„¸ìƒˆë´„ì˜ì› ë°ì´í„° ì¼ê´„ ì…ë ¥</h1>
        <p class="subtitle">CSV íŒŒì¼ì„ ì„ íƒí•˜ê³  "ë°ì´í„° ì…ë ¥ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
        
        <div class="alert warning">
            âš ï¸ <strong>ì£¼ì˜:</strong> ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì…ë ¥í•©ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ì§„í–‰í•´ì£¼ì„¸ìš”.
        </div>
        
        <div class="file-input-wrapper">
            <input type="file" id="csvFile" accept=".csv" />
        </div>
        
        <button id="startBtn">ë°ì´í„° ì…ë ¥ ì‹œì‘</button>
        
        <div class="progress-container" id="progressContainer">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="parentCount">0</div>
                    <div class="stat-label">ë¶€ëª¨</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="childCount">0</div>
                    <div class="stat-label">ì•„ì´</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="measurementCount">0</div>
                    <div class="stat-label">ì¸¡ì • ê¸°ë¡</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const SUPABASE_URL = 'https://mufjnulwnppgvibmmbfo.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_3hm8ooVxIZvENDh-D_lWNA_sdPHg9xk';
        
        let supabaseClient;
        
        // Supabase ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ Supabase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('Supabase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        });

        let stats = {
            parents: 0,
            children: 0,
            measurements: 0
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStats() {
            document.getElementById('parentCount').textContent = stats.parents;
            document.getElementById('childCount').textContent = stats.children;
            document.getElementById('measurementCount').textContent = stats.measurements;
        }

        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
        }

        // ë‚˜ì´ ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜ (ì˜ˆ: "12ì„¸3ê°œì›”" -> 12.25)
        function parseAge(ageStr) {
            if (!ageStr || ageStr.trim() === '') return null;
            
            const match = ageStr.match(/(\d+)ì„¸(\d+)?ê°œì›”?/);
            if (!match) return null;
            
            const years = parseInt(match[1]);
            const months = match[2] ? parseInt(match[2]) : 0;
            return parseFloat((years + months / 12).toFixed(2));
        }

        // CSV íŒŒì‹±
        function parseCSV(text) {
            const lines = text.split('\n');
            const patients = [];
            let currentPatient = null;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // ë©€í‹°ë¼ì¸ ì²˜ë¦¬ (ë”°ì˜´í‘œë¡œ ê°ì‹¸ì§„ í•„ë“œ)
                let fullLine = line;
                while ((fullLine.match(/"/g) || []).length % 2 !== 0 && i + 1 < lines.length) {
                    i++;
                    fullLine += '\n' + lines[i].trim();
                }

                const fields = parseCSVLine(fullLine);
                
                if (fields[0] && fields[0].trim() !== '') {
                    // ìƒˆ í™˜ì
                    currentPatient = {
                        parentId: parseInt(fields[0]),
                        chartNumber: fields[1],
                        childName: fields[2],
                        birthDate: fields[3],
                        gender: fields[4],
                        fatherHeight: parseFloat(fields[5]) || null,
                        motherHeight: parseFloat(fields[6]) || null,
                        targetHeight: parseFloat(fields[7]) || null,
                        consultMemo: fields[8] || '',
                        measurements: []
                    };
                    patients.push(currentPatient);
                }

                // ì¸¡ì • ê¸°ë¡ ì¶”ê°€
                if (currentPatient && fields[9]) {
                    const actualAge = parseAge(fields[12]);
                    const boneAge = parseAge(fields[13]);
                    
                    currentPatient.measurements.push({
                        date: fields[9],
                        height: parseFloat(fields[10]) || null,
                        weight: parseFloat(fields[11]) || null,
                        actualAge: actualAge,
                        boneAge: boneAge,
                        pah: parseFloat(fields[14]) || null,
                        memo: (fields[15] || '') + (fields[16] ? ' ' + fields[16] : '')
                    });
                }
            }

            return patients;
        }

        function parseCSVLine(line) {
            const fields = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    fields.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            fields.push(current.trim());

            return fields;
        }

        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('startBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!supabaseClient) {
                alert('Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì´ˆê¸°í™”
            document.getElementById('startBtn').disabled = true;
            document.getElementById('progressContainer').classList.add('active');
            stats = { parents: 0, children: 0, measurements: 0 };
            updateStats();
            document.getElementById('logContainer').innerHTML = '';

            try {
                log('CSV íŒŒì¼ ì½ê¸° ì¤‘...', 'info');
                const text = await file.text();
                
                log('CSV íŒŒì‹± ì¤‘...', 'info');
                const patients = parseCSV(text);
                log(`âœ… ${patients.length}ëª…ì˜ í™˜ì ë°ì´í„° íŒŒì‹± ì™„ë£Œ`, 'success');

                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œëŠ” ìˆ˜ë™ìœ¼ë¡œ í•˜ì„¸ìš” (Supabase SQL Editor)
                log('âš ï¸ ê¸°ì¡´ ë°ì´í„°ëŠ” Supabase SQL Editorì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì„¸ìš”', 'info');

                // ì „ì²´ ì‘ì—… ìˆ˜ ê³„ì‚°
                let totalMeasurements = 0;
                patients.forEach(p => totalMeasurements += p.measurements.length);
                const totalSteps = patients.length * 2 + totalMeasurements;
                let currentStep = 0;

                // ë°ì´í„° ì…ë ¥
                for (const patient of patients) {
                    log(`ğŸ‘¤ [${patient.parentId}] ${patient.childName} ì²˜ë¦¬ ì¤‘...`, 'info');

                    try {
                        // 1. ë¶€ëª¨ ì¶”ê°€
                        const email = `${String(patient.parentId).padStart(4, '0')}@example.com`;
                        const parentData = {
                            name: `ë¶€ëª¨${patient.parentId}`,
                            email: email,
                            password: '1234',
                            phone: '010-0000-0000',
                            role: 'parent'
                        };

                        let parent;
                        const { data: insertedParent, error: parentError } = await supabaseClient
                            .from('users')
                            .insert(parentData)
                            .select()
                            .single();

                        if (parentError) {
                            if (parentError.code === '23505') {
                                const { data: existingParent } = await supabaseClient
                                    .from('users')
                                    .select('*')
                                    .eq('email', email)
                                    .single();
                                parent = existingParent;
                                log(`  â„¹ï¸ ë¶€ëª¨ ${email} ì´ë¯¸ ì¡´ì¬`, 'info');
                            } else {
                                throw parentError;
                            }
                        } else {
                            parent = insertedParent;
                            stats.parents++;
                            log(`  âœ… ë¶€ëª¨ ì¶”ê°€: ${email}`, 'success');
                        }

                        currentStep++;
                        updateProgress(currentStep, totalSteps);
                        updateStats();

                        // 2. ì•„ì´ ì¶”ê°€ (ì¤‘ë³µ ì²´í¬)
                        const { data: existingChildren, error: checkError } = await supabaseClient
                            .from('children')
                            .select('*')
                            .eq('parent_id', parent.id)
                            .eq('name', patient.childName)
                            .eq('birth_date', patient.birthDate);

                        let child;
                        if (existingChildren && existingChildren.length > 0) {
                            child = existingChildren[0];
                            log(`  â„¹ï¸ ì•„ì´ ${patient.childName} ì´ë¯¸ ì¡´ì¬`, 'info');
                        } else {
                            const childData = {
                                parent_id: parent.id,
                                name: patient.childName,
                                birth_date: patient.birthDate,
                                gender: patient.gender === 'M' ? 'male' : 'female'
                            };

                            const { data: newChild, error: childError } = await supabaseClient
                                .from('children')
                                .insert(childData)
                                .select()
                                .single();

                            if (childError) throw childError;

                            child = newChild;
                            stats.children++;
                            log(`  âœ… ì•„ì´ ì¶”ê°€: ${patient.childName}`, 'success');
                        }
                        currentStep++;
                        updateProgress(currentStep, totalSteps);
                        updateStats();

                        // 3. í•„ìˆ˜ ì •ë³´ ì¶”ê°€
                        if (patient.fatherHeight || patient.motherHeight || patient.targetHeight) {
                            const requiredInfoData = {
                                child_id: child.id,
                                father_height: patient.fatherHeight,
                                mother_height: patient.motherHeight,
                                target_height: patient.targetHeight
                            };

                            const { error: infoError } = await supabaseClient
                                .from('child_required_info')
                                .insert(requiredInfoData);

                            if (infoError) throw infoError;
                            log(`  âœ… í•„ìˆ˜ ì •ë³´ ì¶”ê°€`, 'success');
                        }

                        // 4. ì¸¡ì • ê¸°ë¡ ì¶”ê°€ (ì¤‘ë³µ ì²´í¬)
                        for (const measurement of patient.measurements) {
                            // í•„ìˆ˜ í•„ë“œ ì²´í¬: heightê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                            if (!measurement.height || measurement.height <= 0) {
                                log(`  âš ï¸ í‚¤ ë°ì´í„° ì—†ìŒ, ì¸¡ì • ê¸°ë¡ ìŠ¤í‚µ (${measurement.date})`, 'info');
                                continue;
                            }

                            // ì¤‘ë³µ ì²´í¬: ê°™ì€ ë‚ ì§œì˜ ì¸¡ì • ê¸°ë¡ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
                            const { data: existingMeasurements } = await supabaseClient
                                .from('measurements')
                                .select('*')
                                .eq('child_id', child.id)
                                .eq('measured_date', measurement.date);

                            if (existingMeasurements && existingMeasurements.length > 0) {
                                log(`  â„¹ï¸ ì¸¡ì • ê¸°ë¡ ì´ë¯¸ ì¡´ì¬ (${measurement.date})`, 'info');
                                continue;
                            }
                            
                            // age_at_measurement ê³„ì‚° (ìƒë…„ì›”ì¼ ê¸°ì¤€)
                            let ageAtMeasurement = measurement.actualAge;
                            if (!ageAtMeasurement && patient.birthDate && measurement.date) {
                                try {
                                    const birthDate = new Date(patient.birthDate);
                                    const measuredDate = new Date(measurement.date);
                                    const ageInMonths = (measuredDate - birthDate) / (1000 * 60 * 60 * 24 * 30.44);
                                    ageAtMeasurement = parseFloat((ageInMonths / 12).toFixed(2));
                                } catch (e) {
                                    ageAtMeasurement = 0; // ê³„ì‚° ì‹¤íŒ¨ ì‹œ 0
                                }
                            }
                            if (!ageAtMeasurement) ageAtMeasurement = 0; // ì—¬ì „íˆ nullì´ë©´ 0
                            
                            const measurementData = {
                                child_id: child.id,
                                measured_date: measurement.date,
                                height: measurement.height,
                                weight: measurement.weight || 0,
                                bone_age: measurement.boneAge,
                                actual_age: measurement.actualAge || ageAtMeasurement,
                                age_at_measurement: ageAtMeasurement,
                                pah: measurement.pah,
                                notes: measurement.memo.trim()
                            };

                            const { error: measurementError } = await supabaseClient
                                .from('measurements')
                                .insert(measurementData);

                            if (measurementError) {
                                log(`  âŒ ì¸¡ì • ê¸°ë¡ ì¶”ê°€ ì‹¤íŒ¨ (${measurement.date}): ${measurementError.message}`, 'error');
                            } else {
                                stats.measurements++;
                                currentStep++;
                                updateProgress(currentStep, totalSteps);
                                updateStats();
                            }
                        }

                        log(`  âœ… ${patient.childName} ì™„ë£Œ (ì¸¡ì • ê¸°ë¡ ${patient.measurements.length}ê°œ)`, 'success');
                    } catch (error) {
                        log(`  âŒ ${patient.childName} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
                        console.error('í™˜ì ì²˜ë¦¬ ì˜¤ë¥˜ ìƒì„¸:', {
                            patient: patient.childName,
                            error: error,
                            errorMessage: error.message,
                            errorDetails: error.details,
                            errorHint: error.hint,
                            errorCode: error.code
                        });
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                log('', 'info');
                log('ğŸ‰ ëª¨ë“  ë°ì´í„° ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                log(`ğŸ“Š ìµœì¢… í†µê³„: ë¶€ëª¨ ${stats.parents}ëª…, ì•„ì´ ${stats.children}ëª…, ì¸¡ì • ê¸°ë¡ ${stats.measurements}ê°œ`, 'success');
                
                const container = document.querySelector('.container');
                const successAlert = document.createElement('div');
                successAlert.className = 'alert success';
                successAlert.innerHTML = `
                    âœ… <strong>ì…ë ¥ ì™„ë£Œ!</strong><br>
                    ë¶€ëª¨ ${stats.parents}ëª…, ì•„ì´ ${stats.children}ëª…, ì¸¡ì • ê¸°ë¡ ${stats.measurements}ê°œê°€ ì„±ê³µì ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    ì´ì œ ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¶€ëª¨ IDë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë¹„ë°€ë²ˆí˜¸: 1234)
                `;
                container.insertBefore(successAlert, container.firstChild);

            } catch (error) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                console.error('Import error:', error);
                alert('ë°ì´í„° ì…ë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            } finally {
                document.getElementById('startBtn').disabled = false;
            }
        });
    </script>
</body>
</html>
