// KCDC 2017 표준 성장곡선 데이터 (확장판)
// 출처: 질병관리청 소아청소년 성장도표

const growthData = {
    male: {
        height: [
            { age: 2, p5: 82.5, p10: 84.0, p25: 85.8, p50: 86.7, p75: 88.5, p90: 90.2, p95: 91.2 },
            { age: 3, p5: 89.6, p10: 91.3, p25: 93.4, p50: 94.9, p75: 97.0, p90: 99.2, p95: 100.4 },
            { age: 4, p5: 95.9, p10: 97.8, p25: 100.2, p50: 102.3, p75: 104.9, p90: 107.6, p95: 109.0 },
            { age: 5, p5: 101.7, p10: 103.8, p25: 106.5, p50: 109.2, p75: 112.3, p90: 115.4, p95: 117.0 },
            { age: 6, p5: 107.2, p10: 109.5, p25: 112.5, p50: 115.5, p75: 118.9, p90: 122.3, p95: 124.1 },
            { age: 7, p5: 112.4, p10: 114.8, p25: 118.0, p50: 121.2, p75: 124.9, p90: 128.5, p95: 130.6 },
            { age: 8, p5: 117.3, p10: 119.9, p25: 123.3, p50: 126.6, p75: 130.5, p90: 134.4, p95: 136.6 },
            { age: 9, p5: 121.9, p10: 124.6, p25: 128.2, p50: 131.7, p75: 135.9, p90: 140.0, p95: 142.4 },
            { age: 10, p5: 126.5, p10: 129.4, p25: 133.3, p50: 137.2, p75: 141.8, p90: 146.3, p95: 148.8 },
            { age: 11, p5: 131.7, p10: 134.8, p25: 139.1, p50: 143.4, p75: 148.4, p90: 153.4, p95: 156.0 },
            { age: 12, p5: 137.7, p10: 141.1, p25: 145.8, p50: 150.5, p75: 155.8, p90: 160.8, p95: 163.3 },
            { age: 13, p5: 144.5, p10: 148.2, p25: 153.0, p50: 157.5, p75: 162.5, p90: 167.1, p95: 169.5 },
            { age: 14, p5: 150.9, p10: 154.3, p25: 158.8, p50: 163.1, p75: 167.6, p90: 171.8, p95: 173.9 },
            { age: 15, p5: 155.7, p10: 158.9, p25: 163.0, p50: 166.7, p75: 170.7, p90: 174.5, p95: 176.4 },
            { age: 16, p5: 158.7, p10: 161.7, p25: 165.5, p50: 168.7, p75: 172.4, p90: 176.0, p95: 177.7 },
            { age: 17, p5: 160.5, p10: 163.3, p25: 166.9, p50: 169.8, p75: 173.3, p90: 176.7, p95: 178.4 },
            { age: 18, p5: 161.4, p10: 164.2, p25: 167.6, p50: 170.3, p75: 173.7, p90: 177.0, p95: 178.7 }
        ],
        weight: [
            { age: 2, p5: 10.7, p10: 11.1, p25: 11.8, p50: 12.6, p75: 13.5, p90: 14.5, p95: 15.0 },
            { age: 3, p5: 12.4, p10: 12.9, p25: 13.7, p50: 14.6, p75: 15.7, p90: 16.9, p95: 17.5 },
            { age: 4, p5: 14.0, p10: 14.6, p25: 15.5, p50: 16.7, p75: 18.0, p90: 19.6, p95: 20.4 },
            { age: 5, p5: 15.7, p10: 16.3, p25: 17.4, p50: 18.9, p75: 20.6, p90: 22.6, p95: 23.6 },
            { age: 6, p5: 17.4, p10: 18.2, p25: 19.5, p50: 21.2, p75: 23.3, p90: 25.9, p95: 27.2 },
            { age: 7, p5: 19.3, p10: 20.2, p25: 21.7, p50: 23.7, p75: 26.3, p90: 29.6, p95: 31.3 },
            { age: 8, p5: 21.3, p10: 22.4, p25: 24.2, p50: 26.5, p75: 29.6, p90: 33.7, p95: 35.9 },
            { age: 9, p5: 23.6, p10: 24.9, p25: 27.0, p50: 29.7, p75: 33.5, p90: 38.5, p95: 41.2 },
            { age: 10, p5: 26.3, p10: 27.8, p25: 30.3, p50: 33.4, p75: 37.9, p90: 43.9, p95: 47.1 },
            { age: 11, p5: 29.6, p10: 31.4, p25: 34.4, p50: 37.7, p75: 42.9, p90: 49.9, p95: 53.6 },
            { age: 12, p5: 33.6, p10: 35.7, p25: 39.1, p50: 42.7, p75: 48.5, p90: 56.1, p95: 60.2 },
            { age: 13, p5: 38.3, p10: 40.7, p25: 44.4, p50: 48.3, p75: 54.3, p90: 61.8, p95: 66.1 },
            { age: 14, p5: 43.4, p10: 45.9, p25: 49.8, p50: 53.8, p75: 59.6, p90: 66.8, p95: 71.0 },
            { age: 15, p5: 48.2, p10: 50.6, p25: 54.4, p50: 58.4, p75: 63.8, p90: 70.5, p95: 74.5 },
            { age: 16, p5: 51.8, p10: 54.1, p25: 57.7, p50: 61.7, p75: 66.8, p90: 73.1, p95: 76.8 },
            { age: 17, p5: 54.3, p10: 56.4, p25: 59.8, p50: 63.7, p75: 68.6, p90: 74.6, p95: 78.2 },
            { age: 18, p5: 55.8, p10: 57.9, p25: 61.1, p50: 64.9, p75: 69.6, p90: 75.4, p95: 79.0 }
        ]
    },
    female: {
        height: [
            { age: 2, p5: 80.8, p10: 82.2, p25: 83.9, p50: 85.1, p75: 86.7, p90: 88.4, p95: 89.5 },
            { age: 3, p5: 88.3, p10: 89.9, p25: 91.9, p50: 93.4, p75: 95.4, p90: 97.5, p95: 98.7 },
            { age: 4, p5: 94.9, p10: 96.7, p25: 99.0, p50: 100.8, p75: 103.1, p90: 105.6, p95: 107.0 },
            { age: 5, p5: 101.0, p10: 103.0, p25: 105.5, p50: 107.6, p75: 110.4, p90: 113.3, p95: 114.9 },
            { age: 6, p5: 106.6, p10: 108.7, p25: 111.5, p50: 113.8, p75: 116.9, p90: 120.1, p95: 121.8 },
            { age: 7, p5: 111.8, p10: 114.1, p25: 117.1, p50: 119.6, p75: 123.0, p90: 126.5, p95: 128.3 },
            { age: 8, p5: 116.7, p10: 119.2, p25: 122.4, p50: 125.2, p75: 129.0, p90: 132.8, p95: 134.7 },
            { age: 9, p5: 122.0, p10: 124.7, p25: 128.2, p50: 131.2, p75: 135.4, p90: 139.6, p95: 141.6 },
            { age: 10, p5: 128.0, p10: 131.0, p25: 134.9, p50: 138.0, p75: 142.6, p90: 147.1, p95: 149.1 },
            { age: 11, p5: 135.0, p10: 138.3, p25: 142.3, p50: 145.2, p75: 149.8, p90: 154.3, p95: 156.4 },
            { age: 12, p5: 142.1, p10: 145.2, p25: 148.9, p50: 151.5, p75: 155.5, p90: 159.5, p95: 161.5 },
            { age: 13, p5: 147.7, p10: 150.4, p25: 153.6, p50: 155.8, p75: 159.0, p90: 162.4, p95: 164.2 },
            { age: 14, p5: 150.9, p10: 153.3, p25: 156.1, p50: 158.0, p75: 160.7, p90: 163.7, p95: 165.3 },
            { age: 15, p5: 152.2, p10: 154.5, p25: 157.1, p50: 159.0, p75: 161.5, p90: 164.3, p95: 165.8 },
            { age: 16, p5: 152.8, p10: 155.0, p25: 157.5, p50: 159.4, p75: 161.8, p90: 164.5, p95: 166.0 },
            { age: 17, p5: 153.0, p10: 155.2, p25: 157.7, p50: 159.6, p75: 161.9, p90: 164.6, p95: 166.1 },
            { age: 18, p5: 153.1, p10: 155.3, p25: 157.8, p50: 159.7, p75: 162.0, p90: 164.7, p95: 166.2 }
        ],
        weight: [
            { age: 2, p5: 10.1, p10: 10.5, p25: 11.2, p50: 12.0, p75: 12.9, p90: 13.9, p95: 14.4 },
            { age: 3, p5: 11.9, p10: 12.4, p25: 13.2, p50: 14.1, p75: 15.2, p90: 16.5, p95: 17.1 },
            { age: 4, p5: 13.6, p10: 14.2, p25: 15.2, p50: 16.4, p75: 17.8, p90: 19.4, p95: 20.2 },
            { age: 5, p5: 15.4, p10: 16.1, p25: 17.2, p50: 18.8, p75: 20.6, p90: 22.7, p95: 23.7 },
            { age: 6, p5: 17.2, p10: 18.1, p25: 19.5, p50: 21.4, p75: 23.7, p90: 26.4, p95: 27.7 },
            { age: 7, p5: 19.3, p10: 20.3, p25: 22.0, p50: 24.3, p75: 27.2, p90: 30.7, p95: 32.4 },
            { age: 8, p5: 21.6, p10: 22.8, p25: 24.9, p50: 27.6, p75: 31.2, p90: 35.5, p95: 37.6 },
            { age: 9, p5: 24.3, p10: 25.7, p25: 28.2, p50: 31.4, p75: 35.7, p90: 41.0, p95: 43.6 },
            { age: 10, p5: 27.7, p10: 29.4, p25: 32.4, p50: 35.9, p75: 41.0, p90: 47.1, p95: 50.1 },
            { age: 11, p5: 32.0, p10: 34.0, p25: 37.5, p50: 41.2, p75: 46.9, p90: 53.6, p95: 56.9 },
            { age: 12, p5: 37.1, p10: 39.4, p25: 43.1, p50: 46.6, p75: 52.0, p90: 58.7, p95: 62.2 },
            { age: 13, p5: 41.9, p10: 44.3, p25: 47.9, p50: 50.9, p75: 55.5, p90: 61.7, p95: 65.2 },
            { age: 14, p5: 45.3, p10: 47.5, p25: 50.8, p50: 53.5, p75: 57.6, p90: 63.4, p95: 66.8 },
            { age: 15, p5: 47.2, p10: 49.3, p25: 52.4, p50: 54.9, p75: 58.8, p90: 64.4, p95: 67.6 },
            { age: 16, p5: 48.3, p10: 50.3, p25: 53.3, p50: 55.5, p75: 59.3, p90: 64.8, p95: 67.9 },
            { age: 17, p5: 48.8, p10: 50.7, p25: 53.6, p50: 55.8, p75: 59.5, p90: 65.0, p95: 68.1 },
            { age: 18, p5: 49.0, p10: 50.9, p25: 53.7, p50: 55.9, p75: 59.6, p90: 65.1, p95: 68.2 }
        ]
    }
};

// 선형 보간으로 특정 나이의 백분위 값 계산
function interpolatePercentile(gender, type, age) {
    const data = growthData[gender][type];
    
    // 정확한 나이가 있는 경우
    const exactMatch = data.find(d => d.age === age);
    if (exactMatch) {
        return exactMatch;
    }
    
    // 선형 보간
    for (let i = 0; i < data.length - 1; i++) {
        if (age >= data[i].age && age <= data[i + 1].age) {
            const ratio = (age - data[i].age) / (data[i + 1].age - data[i].age);
            return {
                age: age,
                p5: data[i].p5 + (data[i + 1].p5 - data[i].p5) * ratio,
                p10: data[i].p10 + (data[i + 1].p10 - data[i].p10) * ratio,
                p25: data[i].p25 + (data[i + 1].p25 - data[i].p25) * ratio,
                p50: data[i].p50 + (data[i + 1].p50 - data[i].p50) * ratio,
                p75: data[i].p75 + (data[i + 1].p75 - data[i].p75) * ratio,
                p90: data[i].p90 + (data[i + 1].p90 - data[i].p90) * ratio,
                p95: data[i].p95 + (data[i + 1].p95 - data[i].p95) * ratio
            };
        }
    }
    
    // 범위를 벗어나면 가장 가까운 값 반환
    if (age < data[0].age) return data[0];
    return data[data.length - 1];
}

// 백분위 계산
function calculatePercentile(gender, type, age, value) {
    const percentiles = interpolatePercentile(gender, type, age);
    
    if (value < percentiles.p5) {
        return { level: 'P5 미만', category: 'low' };
    } else if (value < percentiles.p10) {
        return { level: 'P5-P10', category: 'low' };
    } else if (value < percentiles.p25) {
        return { level: 'P10-P25', category: 'normal' };
    } else if (value < percentiles.p50) {
        return { level: 'P25-P50', category: 'normal' };
    } else if (value < percentiles.p75) {
        return { level: 'P50-P75', category: 'normal' };
    } else if (value < percentiles.p90) {
        return { level: 'P75-P90', category: 'normal' };
    } else if (value < percentiles.p95) {
        return { level: 'P90-P95', category: 'high' };
    } else {
        return { level: 'P95 초과', category: 'high' };
    }
}

// 차트용 백분위 데이터 (Chart.js용)
const heightPercentileData = {
    ages: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18],
    male: {
        P5: [82.5, 89.6, 95.9, 101.7, 107.2, 112.4, 117.3, 121.9, 126.5, 131.7, 137.7, 144.5, 150.9, 155.7, 158.7, 160.5, 161.4],
        P50: [86.7, 94.9, 102.3, 109.2, 115.5, 121.2, 126.6, 131.7, 137.2, 143.4, 150.5, 157.5, 163.1, 166.7, 168.7, 169.8, 170.3],
        P95: [91.2, 100.4, 109.0, 117.0, 124.1, 130.6, 136.6, 142.4, 148.8, 156.0, 163.3, 169.5, 173.9, 176.4, 177.7, 178.4, 178.7]
    },
    female: {
        P5: [80.8, 88.3, 94.9, 101.0, 106.5, 111.5, 116.3, 121.0, 126.0, 131.4, 137.4, 143.6, 148.7, 151.8, 153.5, 154.3, 154.7],
        P50: [85.1, 93.4, 100.8, 107.6, 113.9, 119.8, 125.4, 131.1, 137.2, 143.8, 150.2, 155.8, 159.8, 161.8, 162.5, 162.8, 162.9],
        P95: [89.5, 98.7, 107.0, 114.9, 121.7, 128.4, 134.8, 141.4, 147.9, 154.8, 160.8, 164.8, 166.9, 167.6, 167.8, 167.9, 168.0]
    }
};
