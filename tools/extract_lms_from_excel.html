<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—‘ì…€ LMS ë°ì´í„° ì¶”ì¶œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .sheet-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .sheet-card {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .sheet-card:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }
        .sheet-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f1f5f9;
            font-weight: 600;
            color: #334155;
            position: sticky;
            top: 0;
        }
        .data-preview {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-height: 600px;
            overflow-y: auto;
        }
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background: #f0fdf4;
            border-left-color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ì—‘ì…€ LMS ë°ì´í„° ì§ì ‘ ì¶”ì¶œ</h1>
        <p style="color: #64748b; margin-bottom: 20px;">ì—‘ì…€ íŒŒì¼ì—ì„œ LMS ê°’ì„ ì§ì ‘ ì¶”ì¶œí•˜ì—¬ JSONìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤</p>

        <div class="upload-area" id="uploadArea">
            <p style="font-size: 18px; margin-bottom: 10px;">ğŸ“ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
            <p style="color: #64748b; font-size: 14px;">ì„±ì¥ë„í‘œ+ë°ì´í„°+í…Œì´ë¸”.xls</p>
            <input type="file" id="fileInput" accept=".xls,.xlsx" style="display: none;">
        </div>

        <div id="sheetListContainer" style="display: none;">
            <h3>ğŸ“‘ ì‹œíŠ¸ ëª©ë¡ (LMS ë°ì´í„°ê°€ ìˆëŠ” ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”)</h3>
            <div id="sheetList" class="sheet-list"></div>
        </div>

        <div id="result"></div>
        
        <div style="margin-top: 20px; display: none;" id="actionButtons">
            <button id="downloadBtn" style="background: #10b981;">ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ</button>
            <button id="copyBtn" style="background: #f59e0b;">ğŸ“‹ JSON ë³µì‚¬</button>
        </div>
    </div>

    <script>
        let workbook = null;
        let extractedData = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const sheetListContainer = document.getElementById('sheetListContainer');
        const sheetList = document.getElementById('sheetList');
        const resultDiv = document.getElementById('result');
        const actionButtons = document.getElementById('actionButtons');

        // íŒŒì¼ ì—…ë¡œë“œ
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    displaySheetList();
                } catch (error) {
                    resultDiv.innerHTML = `<p class="error">âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${error.message}</p>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displaySheetList() {
            sheetListContainer.style.display = 'block';
            
            sheetList.innerHTML = workbook.SheetNames.map(name => `
                <div class="sheet-card" onclick="analyzeSheet('${name}')">
                    <div style="font-weight: 600; margin-bottom: 5px;">ğŸ“„ ${name}</div>
                    <div style="font-size: 12px; color: #64748b;">í´ë¦­í•˜ì—¬ ë¶„ì„</div>
                </div>
            `).join('');
        }

        function analyzeSheet(sheetName) {
            const sheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

            // ëª¨ë“  ì¹´ë“œ ì„ íƒ í•´ì œ
            document.querySelectorAll('.sheet-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
            let html = '<div class="data-preview">';
            html += `<h3>ğŸ“‹ ì‹œíŠ¸: ${sheetName}</h3>`;
            html += '<p style="color: #64748b; margin-bottom: 15px;">ì²˜ìŒ 20í–‰ì„ í‘œì‹œí•©ë‹ˆë‹¤. LMS ì»¬ëŸ¼(L, M, S)ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>';
            
            html += '<table><thead><tr>';
            const header = data[0] || [];
            header.slice(0, 15).forEach((cell, idx) => {
                const cellStr = String(cell).toLowerCase();
                let highlight = '';
                if (cellStr === 'l' || cellStr === 'm' || cellStr === 's' || 
                    cellStr.includes('lambda') || cellStr.includes('mu') || cellStr.includes('sigma')) {
                    highlight = 'style="background: #fef3c7; font-weight: 700;"';
                }
                html += `<th ${highlight}>${cell || `Col${idx+1}`}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.slice(1, 21).forEach(row => {
                html += '<tr>';
                row.slice(0, 15).forEach(cell => {
                    html += `<td>${cell !== undefined && cell !== '' ? cell : '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += `<p style="color: #64748b; margin-top: 10px;">ì´ ${data.length}í–‰ Ã— ${header.length}ì—´</p>`;
            html += '</div>';

            // LMS ì»¬ëŸ¼ ìë™ ê°ì§€
            const lmsInfo = detectLMSColumns(data);
            if (lmsInfo.found) {
                html += '<div class="info-box success">';
                html += '<strong>âœ… LMS ì»¬ëŸ¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!</strong><br>';
                html += `ë‚˜ì´/ê°œì›”: ${lmsInfo.ageCol}ë²ˆ ì»¬ëŸ¼, L: ${lmsInfo.lCol}ë²ˆ, M: ${lmsInfo.mCol}ë²ˆ, S: ${lmsInfo.sCol}ë²ˆ ì»¬ëŸ¼<br>`;
                html += `<button onclick="extractLMSData('${sheetName}')" style="margin-top: 10px;">ğŸ”„ LMS ë°ì´í„° ì¶”ì¶œí•˜ê¸°</button>`;
                html += '</div>';
            } else {
                html += '<div class="info-box">';
                html += '<strong>âš ï¸ LMS ì»¬ëŸ¼ì„ ìë™ìœ¼ë¡œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</strong><br>';
                html += 'í—¤ë” í–‰ì— "L", "M", "S" ë˜ëŠ” "Lambda", "Mu", "Sigma"ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
                html += '</div>';
            }

            resultDiv.innerHTML = html;
        }

        function detectLMSColumns(data) {
            if (data.length < 2) return { found: false };

            const header = data[0].map(cell => String(cell).toLowerCase().trim());
            
            // ë‚˜ì´/ê°œì›” ì»¬ëŸ¼ ì°¾ê¸°
            let ageCol = header.findIndex(h => 
                h.includes('age') || h.includes('month') || h.includes('ë‚˜ì´') || 
                h.includes('ê°œì›”') || h.includes('ì—°ë ¹') || h === 'age'
            );

            // LMS ì»¬ëŸ¼ ì°¾ê¸°
            let lCol = header.findIndex(h => h === 'l' || h.includes('lambda'));
            let mCol = header.findIndex(h => h === 'm' || h.includes('mu') || h.includes('median'));
            let sCol = header.findIndex(h => h === 's' || h.includes('sigma'));

            // ì»¬ëŸ¼ ìœ„ì¹˜ë¡œ ì¶”ì • (ë³´í†µ ì—°ì†ëœ ì»¬ëŸ¼)
            if (lCol === -1 || mCol === -1 || sCol === -1) {
                // ìˆ«ìê°€ ìˆëŠ” ì»¬ëŸ¼ ì°¾ê¸°
                for (let i = 1; i < header.length - 2; i++) {
                    const val1 = data[1][i];
                    const val2 = data[1][i+1];
                    const val3 = data[1][i+2];
                    
                    if (typeof val1 === 'number' && typeof val2 === 'number' && typeof val3 === 'number') {
                        if (Math.abs(val1) < 3 && val2 > 10 && Math.abs(val3) < 1) {
                            lCol = i;
                            mCol = i + 1;
                            sCol = i + 2;
                            break;
                        }
                    }
                }
            }

            const found = lCol >= 0 && mCol >= 0 && sCol >= 0;
            
            return { found, ageCol, lCol, mCol, sCol };
        }

        function extractLMSData(sheetName) {
            const sheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
            
            const lmsInfo = detectLMSColumns(data);
            if (!lmsInfo.found) {
                alert('LMS ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const results = [];
            
            // ë°ì´í„° í–‰ ì¶”ì¶œ (í—¤ë” ì œì™¸)
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                let age = lmsInfo.ageCol >= 0 ? row[lmsInfo.ageCol] : null;
                const L = row[lmsInfo.lCol];
                const M = row[lmsInfo.mCol];
                const S = row[lmsInfo.sCol];

                // ìœ íš¨ì„± ê²€ì‚¬
                if (typeof L !== 'number' || typeof M !== 'number' || typeof S !== 'number') continue;
                if (M < 10 || M > 200) continue; // í‚¤ ë²”ìœ„
                if (Math.abs(S) > 1) continue; // S ë²”ìœ„

                // ë‚˜ì´ ê³„ì‚° (ê°œì›” â†’ ë…„)
                if (typeof age === 'number' && age > 18) {
                    age = age / 12; // ê°œì›”ì„ ë…„ìœ¼ë¡œ ë³€í™˜
                }
                if (!age || age < 0 || age > 20) continue;

                results.push({
                    age: Math.round(age * 10) / 10,
                    L: Math.round(L * 10000) / 10000,
                    M: Math.round(M * 10) / 10,
                    S: Math.round(S * 10000) / 10000
                });
            }

            // ë‚˜ì´ìˆœ ì •ë ¬
            results.sort((a, b) => a.age - b.age);

            displayExtractedData(sheetName, results);
        }

        function displayExtractedData(sheetName, results) {
            extractedData = { sheetName, results };

            let html = '<div class="info-box success">';
            html += `<strong>âœ… ${results.length}ê°œì˜ LMS ë°ì´í„°ë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤!</strong>`;
            html += '</div>';

            html += '<div class="data-preview">';
            html += `<h3>ğŸ“Š ì¶”ì¶œëœ LMS ë°ì´í„°: ${sheetName}</h3>`;
            html += '<table><thead><tr><th>ë‚˜ì´</th><th>L</th><th>M</th><th>S</th></tr></thead><tbody>';
            
            results.forEach(item => {
                html += `<tr>
                    <td>${item.age}</td>
                    <td>${item.L}</td>
                    <td>${item.M}</td>
                    <td>${item.S}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';

            resultDiv.innerHTML = html;
            actionButtons.style.display = 'block';
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!extractedData) return;

            const json = {
                metadata: {
                    source: "ëŒ€í•œì†Œì•„ê³¼í•™íšŒ 2017 í•œêµ­ ì†Œì•„ì²­ì†Œë…„ ì„±ì¥ë„í‘œ",
                    sheet: extractedData.sheetName,
                    extracted: new Date().toISOString(),
                    count: extractedData.results.length
                },
                data: extractedData.results
            };

            const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lms_${extractedData.sheetName.replace(/[^a-zA-Z0-9]/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            if (!extractedData) return;

            const jsonText = JSON.stringify(extractedData.results, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                alert('JSON ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        });
    </script>
</body>
</html>
