<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ í‘œì¤€ ì„±ì¥ë„í‘œ ë°ì´í„° ì¶”ì¶œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        #output {
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        .info {
            background: #dbeafe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #1e40af;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
        }
        .sheet-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .sheet-btn {
            padding: 8px 16px;
            background: #e2e8f0;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            color: #334155;
        }
        .sheet-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š í•œêµ­ í‘œì¤€ ì„±ì¥ë„í‘œ ë°ì´í„° ì¶”ì¶œ ë„êµ¬</h1>
        
        <div id="statusMessage" class="info">
            â³ ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ì¤‘...
        </div>

        <div class="controls">
            <button onclick="loadExcel()" id="loadBtn">ğŸ“‚ ì—‘ì…€ íŒŒì¼ ë‹¤ì‹œ ë¡œë“œ</button>
            <button onclick="extractAllData()" id="extractBtn" disabled>ğŸ”„ ëª¨ë“  ë°ì´í„° ì¶”ì¶œ (JSON)</button>
            <button onclick="downloadJSON()" id="downloadBtn" disabled>ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ</button>
            <button onclick="copyToClipboard()" id="copyBtn" disabled>ğŸ“‹ JSON ë³µì‚¬</button>
        </div>

        <div id="sheetList" class="sheet-list"></div>
        <div id="output" class="loading">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <script>
        let workbook = null;
        let extractedData = null;
        const EXCEL_URL = 'https://www.genspark.ai/api/files/s/6zJ3vI3e';

        async function loadExcel() {
            try {
                updateStatus('â³ ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ì¤‘...', 'info');
                
                const response = await fetch(EXCEL_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('ì›Œí¬ë¶ ë¡œë“œ ì™„ë£Œ:', workbook.SheetNames);
                
                updateStatus(`âœ… ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì„±ê³µ! (${workbook.SheetNames.length}ê°œ ì‹œíŠ¸)`, 'success');
                document.getElementById('extractBtn').disabled = false;
                
                displaySheetList();
                
                let output = `ì´ ì‹œíŠ¸ ìˆ˜: ${workbook.SheetNames.length}\n\n`;
                output += `ì‹œíŠ¸ ëª©ë¡:\n${workbook.SheetNames.map((name, i) => `  ${i+1}. ${name}`).join('\n')}\n\n`;
                output += `ğŸ’¡ "ëª¨ë“  ë°ì´í„° ì¶”ì¶œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ JSON ë°ì´í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”.`;
                
                document.getElementById('output').textContent = output;
                
            } catch (error) {
                console.error('ì—‘ì…€ ë¡œë“œ ì‹¤íŒ¨:', error);
                updateStatus('âŒ ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                document.getElementById('output').textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
            }
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = type === 'success' ? 'info success' : 
                                 type === 'error' ? 'info error' : 'info';
        }

        function displaySheetList() {
            const container = document.getElementById('sheetList');
            container.innerHTML = workbook.SheetNames.map((name, index) => 
                `<button class="sheet-btn" onclick="showSheet(${index})">${name}</button>`
            ).join('');
        }

        function showSheet(index) {
            const sheetName = workbook.SheetNames[index];
            const sheet = workbook.Sheets[sheetName];
            
            document.querySelectorAll('.sheet-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
            
            let html = `<h3>ğŸ“„ ì‹œíŠ¸: ${sheetName}</h3>`;
            html += `<p>ì´ ${jsonData.length}í–‰ Ã— ${jsonData[0]?.length || 0}ì—´</p>`;
            html += '<div style="overflow-x: auto;"><table><thead><tr>';
            
            if (jsonData.length > 0) {
                jsonData[0].forEach((cell, i) => {
                    html += `<th>${cell || `Col ${i+1}`}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                for (let i = 1; i < Math.min(jsonData.length, 201); i++) {
                    html += '<tr>';
                    const maxCols = jsonData[0].length;
                    for (let j = 0; j < maxCols; j++) {
                        const cell = jsonData[i][j];
                        html += `<td>${cell !== undefined && cell !== '' ? cell : '-'}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            document.getElementById('output').innerHTML = html;
        }

        function extractAllData() {
            if (!workbook) {
                alert('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”!');
                return;
            }

            updateStatus('ğŸ”„ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” ì¤‘...', 'info');

            extractedData = {
                male: { height: [], weight: [] },
                female: { height: [], weight: [] },
                metadata: {
                    source: 'ëŒ€í•œì†Œì•„ê³¼í•™íšŒ 2017 í•œêµ­ ì†Œì•„ì²­ì†Œë…„ ì„±ì¥ë„í‘œ',
                    method: 'LMS',
                    extractedAt: new Date().toISOString()
                }
            };

            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
                
                console.log(`\n=== ì‹œíŠ¸: ${sheetName} ===`);
                
                const nameLower = sheetName.toLowerCase().replace(/\s+/g, '');
                let gender = null;
                let type = null;
                
                // ì„±ë³„ íŒë‹¨
                if (nameLower.includes('ë‚¨') || nameLower.includes('boy') || nameLower.includes('male')) {
                    gender = 'male';
                } else if (nameLower.includes('ì—¬') || nameLower.includes('girl') || nameLower.includes('female')) {
                    gender = 'female';
                }
                
                // ìœ í˜• íŒë‹¨
                if (nameLower.includes('í‚¤') || nameLower.includes('ì‹ ì¥') || nameLower.includes('height') || nameLower.includes('stature')) {
                    type = 'height';
                } else if (nameLower.includes('ëª¸ë¬´ê²Œ') || nameLower.includes('ì²´ì¤‘') || nameLower.includes('weight')) {
                    type = 'weight';
                }
                
                console.log(`ê°ì§€: ì„±ë³„=${gender}, ìœ í˜•=${type}`);
                
                if (gender && type && data.length > 1) {
                    const extracted = extractLMSData(data, sheetName);
                    if (extracted.length > 0) {
                        extractedData[gender][type] = extracted;
                        console.log(`âœ… ${sheetName}: ${extracted.length}ê°œ ë°ì´í„° ì¶”ì¶œ`);
                    }
                }
            });

            // ê²°ê³¼ í‘œì‹œ
            const stats = {
                maleHeight: extractedData.male.height.length,
                maleWeight: extractedData.male.weight.length,
                femaleHeight: extractedData.female.height.length,
                femaleWeight: extractedData.female.weight.length
            };

            if (stats.maleHeight === 0 && stats.maleWeight === 0 && 
                stats.femaleHeight === 0 && stats.femaleWeight === 0) {
                updateStatus('âš ï¸ ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨. ì‹œíŠ¸ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('output').textContent = 
                    'âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n' +
                    'ê° ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ìŒì„ ì²´í¬í•˜ì„¸ìš”:\n' +
                    '1. ì‹œíŠ¸ ì´ë¦„ì— "ë‚¨" ë˜ëŠ” "ì—¬"ê°€ í¬í•¨ë˜ì–´ ìˆë‚˜ìš”?\n' +
                    '2. ì‹œíŠ¸ ì´ë¦„ì— "í‚¤" ë˜ëŠ” "ì²´ì¤‘"ì´ í¬í•¨ë˜ì–´ ìˆë‚˜ìš”?\n' +
                    '3. ë°ì´í„°ì— Age, L, M, S ì»¬ëŸ¼ì´ ìˆë‚˜ìš”?';
                return;
            }

            updateStatus('âœ… ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ!', 'success');
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('copyBtn').disabled = false;

            let output = 'âœ… ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ!\n\n';
            output += `ğŸ“Š í†µê³„:\n`;
            output += `  ë‚¨ì•„ í‚¤ ë°ì´í„°: ${stats.maleHeight}ê°œ\n`;
            output += `  ë‚¨ì•„ ì²´ì¤‘ ë°ì´í„°: ${stats.maleWeight}ê°œ\n`;
            output += `  ì—¬ì•„ í‚¤ ë°ì´í„°: ${stats.femaleHeight}ê°œ\n`;
            output += `  ì—¬ì•„ ì²´ì¤‘ ë°ì´í„°: ${stats.femaleWeight}ê°œ\n\n`;
            
            if (stats.maleHeight > 0) {
                output += 'ğŸ“ ìƒ˜í”Œ ë°ì´í„° (ë‚¨ì•„ í‚¤ ì²˜ìŒ 3ê°œ):\n';
                output += JSON.stringify(extractedData.male.height.slice(0, 3), null, 2) + '\n\n';
            }
            
            if (stats.femaleHeight > 0) {
                output += 'ğŸ“ ìƒ˜í”Œ ë°ì´í„° (ì—¬ì•„ í‚¤ ì²˜ìŒ 3ê°œ):\n';
                output += JSON.stringify(extractedData.female.height.slice(0, 3), null, 2) + '\n\n';
            }
            
            output += 'ğŸ’¾ "JSON ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì €ì¥í•˜ì„¸ìš”.';
            
            document.getElementById('output').textContent = output;
        }

        function extractLMSData(data, sheetName) {
            const result = [];
            
            // í—¤ë” í–‰ ì°¾ê¸°
            let headerRow = -1;
            for (let i = 0; i < Math.min(data.length, 30); i++) {
                const row = data[i];
                if (row && Array.isArray(row)) {
                    const hasLMS = row.some(cell => 
                        cell && (cell.toString().trim() === 'L' || 
                                cell.toString().trim() === 'M' || 
                                cell.toString().trim() === 'S')
                    );
                    if (hasLMS) {
                        headerRow = i;
                        break;
                    }
                }
            }
            
            if (headerRow === -1) {
                console.warn(`${sheetName}: í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                return result;
            }
            
            const headers = data[headerRow].map(h => h ? h.toString().trim() : '');
            console.log(`í—¤ë” (í–‰ ${headerRow}):`, headers);
            
            // ì»¬ëŸ¼ ì°¾ê¸°
            const ageCol = findColumnIndex(headers, ['age', 'month', 'months', 'ë‚˜ì´', 'ì—°ë ¹', 'ì›”ë ¹', 'ê°œì›”']);
            const lCol = findColumnIndex(headers, ['L']);
            const mCol = findColumnIndex(headers, ['M']);
            const sCol = findColumnIndex(headers, ['S']);
            
            console.log(`ì»¬ëŸ¼ ìœ„ì¹˜: Age=${ageCol}, L=${lCol}, M=${mCol}, S=${sCol}`);
            
            if (ageCol === -1 || lCol === -1 || mCol === -1 || sCol === -1) {
                console.warn(`${sheetName}: í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                return result;
            }
            
            // ë°ì´í„° ì¶”ì¶œ
            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !Array.isArray(row)) continue;
                
                const age = parseFloat(row[ageCol]);
                const l = parseFloat(row[lCol]);
                const m = parseFloat(row[mCol]);
                const s = parseFloat(row[sCol]);
                
                if (!isNaN(age) && !isNaN(l) && !isNaN(m) && !isNaN(s)) {
                    result.push({ age, L: l, M: m, S: s });
                }
            }
            
            return result;
        }

        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                if (keywords.some(kw => header === kw.toLowerCase() || header.includes(kw.toLowerCase()))) {
                    return i;
                }
            }
            return -1;
        }

        function downloadJSON() {
            if (!extractedData) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”!');
                return;
            }

            const dataStr = JSON.stringify(extractedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'korea_growth_standard.json';
            a.click();
            URL.revokeObjectURL(url);
            
            updateStatus('âœ… JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        async function copyToClipboard() {
            if (!extractedData) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”!');
                return;
            }

            const dataStr = JSON.stringify(extractedData, null, 2);
            try {
                await navigator.clipboard.writeText(dataStr);
                updateStatus('âœ… JSON ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (err) {
                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadExcel();
        });
    </script>
</body>
</html>
