<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS ë°ì´í„° ìë™ ì¶”ì¶œ ë° ìƒì„±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1600px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background: #f0fdf4;
            border-left-color: #10b981;
        }
        .data-preview {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-height: 500px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        th, td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f1f5f9;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ LMS ë°ì´í„° ìë™ ì¶”ì¶œ ë° JSON ìƒì„±</h1>
        <p style="color: #64748b; margin-bottom: 20px;">ì—‘ì…€ íŒŒì¼ì—ì„œ LMS ê°’ì„ ìë™ìœ¼ë¡œ ì¶”ì¶œí•˜ì—¬ ì™„ì„±ëœ JSON íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤</p>

        <div class="info-box">
            <strong>ğŸ“‚ ëŒ€ìƒ íŒŒì¼:</strong> tools/growth_data_original.xls<br>
            <strong>ğŸ¯ ëª©í‘œ:</strong> ë‚¨ì•„/ì—¬ì•„ ì‹ ì¥Â·ì²´ì¤‘ LMS ë°ì´í„° ì¶”ì¶œ â†’ korea_growth_standard.json ìƒì„±
        </div>

        <button onclick="startExtraction()" style="font-size: 18px; padding: 15px 30px;">
            ğŸš€ ìë™ ì¶”ì¶œ ì‹œì‘
        </button>

        <div id="result"></div>
        <div id="jsonOutput" style="display: none; margin-top: 20px;">
            <h3>ğŸ“„ ìƒì„±ëœ JSON</h3>
            <button onclick="downloadJSON()" style="background: #10b981;">ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ</button>
            <button onclick="copyJSON()" style="background: #f59e0b;">ğŸ“‹ ë³µì‚¬</button>
            <pre id="jsonPreview"></pre>
        </div>
    </div>

    <script>
        let finalJSON = null;

        async function startExtraction() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">ğŸ”„ ì—‘ì…€ íŒŒì¼ì„ ë¡œë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';

            try {
                // ì—‘ì…€ íŒŒì¼ ë¡œë“œ
                const response = await fetch('growth_data_original.xls');
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });

                resultDiv.innerHTML = '<div class="info-box success">âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ! ì‹œíŠ¸ ë¶„ì„ ì¤‘...</div>';

                // ëª¨ë“  ì‹œíŠ¸ ë¶„ì„
                const allSheets = workbook.SheetNames;
                console.log('ë°œê²¬ëœ ì‹œíŠ¸:', allSheets);

                resultDiv.innerHTML += `<p>ì´ ${allSheets.length}ê°œ ì‹œíŠ¸ ë°œê²¬: ${allSheets.join(', ')}</p>`;

                // LMS ë°ì´í„° ì¶”ì¶œ
                const extractedData = {
                    male: { height: [], weight: [] },
                    female: { height: [], weight: [] }
                };

                for (const sheetName of allSheets) {
                    const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: '' });
                    const lmsData = extractLMSFromSheet(sheetName, sheetData);
                    
                    if (lmsData) {
                        const { gender, type, data } = lmsData;
                        extractedData[gender][type] = data;
                        resultDiv.innerHTML += `<p class="success">âœ… ${sheetName}: ${data.length}ê°œ ë°ì´í„° ì¶”ì¶œ</p>`;
                    }
                }

                // JSON ìƒì„±
                generateFinalJSON(extractedData);
                displayResults(extractedData);

            } catch (error) {
                resultDiv.innerHTML = `<div class="info-box" style="border-color: #ef4444; background: #fef2f2;">
                    âŒ ì˜¤ë¥˜: ${error.message}
                </div>`;
                console.error(error);
            }
        }

        function extractLMSFromSheet(sheetName, data) {
            if (data.length < 2) return null;

            const nameLower = sheetName.toLowerCase();
            
            // ì„±ë³„ íŒë‹¨
            let gender = null;
            if (nameLower.includes('ë‚¨') || nameLower.includes('boy') || nameLower.includes('male')) {
                gender = 'male';
            } else if (nameLower.includes('ì—¬') || nameLower.includes('girl') || nameLower.includes('female')) {
                gender = 'female';
            } else {
                return null; // ì„±ë³„ ë¶ˆëª…
            }

            // ìœ í˜• íŒë‹¨ (ì‹ ì¥/ì²´ì¤‘)
            let type = null;
            if (nameLower.includes('ì‹ ì¥') || nameLower.includes('í‚¤') || nameLower.includes('height')) {
                type = 'height';
            } else if (nameLower.includes('ì²´ì¤‘') || nameLower.includes('ëª¸ë¬´ê²Œ') || nameLower.includes('weight')) {
                type = 'weight';
            } else {
                return null; // ìœ í˜• ë¶ˆëª…
            }

            // LMS ì»¬ëŸ¼ ì°¾ê¸°
            const header = data[0].map(cell => String(cell).toLowerCase().trim());
            
            let ageCol = -1, lCol = -1, mCol = -1, sCol = -1;

            // í—¤ë”ì—ì„œ ì»¬ëŸ¼ ì°¾ê¸°
            for (let i = 0; i < header.length; i++) {
                const h = header[i];
                if (h.includes('age') || h.includes('month') || h.includes('ë‚˜ì´') || h.includes('ê°œì›”')) {
                    ageCol = i;
                } else if (h === 'l' || h.includes('lambda')) {
                    lCol = i;
                } else if (h === 'm' || h.includes('mu')) {
                    mCol = i;
                } else if (h === 's' || h.includes('sigma')) {
                    sCol = i;
                }
            }

            // íŒ¨í„´ìœ¼ë¡œ ì°¾ê¸° (ì—°ì†ëœ ìˆ«ì ì»¬ëŸ¼)
            if (lCol === -1 || mCol === -1 || sCol === -1) {
                for (let i = 0; i < header.length - 2; i++) {
                    const row = data[1] || [];
                    const v1 = row[i], v2 = row[i+1], v3 = row[i+2];
                    
                    if (typeof v1 === 'number' && typeof v2 === 'number' && typeof v3 === 'number') {
                        // L: ë³´í†µ -2 ~ 2, M: í‚¤(50~200) ë˜ëŠ” ëª¸ë¬´ê²Œ(3~100), S: 0.01~0.2
                        if (Math.abs(v1) <= 3 && v2 > 3 && v3 > 0.001 && v3 < 1) {
                            lCol = i;
                            mCol = i + 1;
                            sCol = i + 2;
                            break;
                        }
                    }
                }
            }

            if (lCol === -1 || mCol === -1 || sCol === -1) {
                console.warn(`${sheetName}: LMS ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                return null;
            }

            // ë°ì´í„° ì¶”ì¶œ
            const results = [];
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                let age = ageCol >= 0 ? row[ageCol] : null;
                const L = row[lCol];
                const M = row[mCol];
                const S = row[sCol];

                // ìœ íš¨ì„± ê²€ì‚¬
                if (typeof L !== 'number' || typeof M !== 'number' || typeof S !== 'number') continue;
                
                // ë²”ìœ„ ì²´í¬
                if (type === 'height' && (M < 40 || M > 200)) continue;
                if (type === 'weight' && (M < 2 || M > 100)) continue;
                if (Math.abs(S) > 1) continue;
                if (Math.abs(L) > 5) continue;

                // ë‚˜ì´ ì²˜ë¦¬ (ê°œì›” â†’ ë…„)
                if (typeof age === 'number') {
                    if (age > 18) age = age / 12; // ê°œì›”ì„ ë…„ìœ¼ë¡œ
                } else {
                    continue; // ë‚˜ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                }

                if (age < 0 || age > 20) continue;

                results.push({
                    age: Math.round(age * 100) / 100, // ì†Œìˆ˜ì  2ìë¦¬
                    L: Math.round(L * 10000) / 10000,
                    M: Math.round(M * 10) / 10,
                    S: Math.round(S * 10000) / 10000
                });
            }

            // ë‚˜ì´ìˆœ ì •ë ¬ ë° ì¤‘ë³µ ì œê±°
            results.sort((a, b) => a.age - b.age);
            
            // ì¤‘ë³µ ì œê±° (ê°™ì€ ë‚˜ì´ëŠ” ì²« ë²ˆì§¸ë§Œ)
            const uniqueResults = [];
            let lastAge = -1;
            for (const item of results) {
                if (item.age !== lastAge) {
                    uniqueResults.push(item);
                    lastAge = item.age;
                }
            }

            return { gender, type, data: uniqueResults };
        }

        function generateFinalJSON(extractedData) {
            finalJSON = {
                metadata: {
                    source: "ëŒ€í•œì†Œì•„ê³¼í•™íšŒ 2017 í•œêµ­ ì†Œì•„ì²­ì†Œë…„ ì„±ì¥ë„í‘œ",
                    method: "LMS",
                    description: "Lambda-Mu-Sigma ë°©ë²•ì„ ì‚¬ìš©í•œ í•œêµ­ í‘œì¤€ ì„±ì¥ ë°ì´í„°",
                    extracted: new Date().toISOString(),
                    ageUnit: "years",
                    heightUnit: "cm",
                    weightUnit: "kg"
                },
                male: {
                    height: extractedData.male.height,
                    weight: extractedData.male.weight
                },
                female: {
                    height: extractedData.female.height,
                    weight: extractedData.female.weight
                }
            };
        }

        function displayResults(extractedData) {
            const resultDiv = document.getElementById('result');
            
            let html = '<div class="info-box success">';
            html += '<strong>âœ… LMS ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ!</strong><br><br>';
            html += `ë‚¨ì•„ ì‹ ì¥: ${extractedData.male.height.length}ê°œ<br>`;
            html += `ë‚¨ì•„ ì²´ì¤‘: ${extractedData.male.weight.length}ê°œ<br>`;
            html += `ì—¬ì•„ ì‹ ì¥: ${extractedData.female.height.length}ê°œ<br>`;
            html += `ì—¬ì•„ ì²´ì¤‘: ${extractedData.female.weight.length}ê°œ<br>`;
            html += `<strong>ì´ ${extractedData.male.height.length + extractedData.male.weight.length + extractedData.female.height.length + extractedData.female.weight.length}ê°œ ë°ì´í„°</strong>`;
            html += '</div>';

            // ê° ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
            ['male', 'female'].forEach(gender => {
                ['height', 'weight'].forEach(type => {
                    const data = extractedData[gender][type];
                    if (data.length > 0) {
                        html += `<div class="data-preview">`;
                        html += `<h3>${gender === 'male' ? 'ë‚¨ì•„' : 'ì—¬ì•„'} ${type === 'height' ? 'ì‹ ì¥' : 'ì²´ì¤‘'} (${data.length}ê°œ)</h3>`;
                        html += '<table><thead><tr><th>ë‚˜ì´</th><th>L</th><th>M</th><th>S</th></tr></thead><tbody>';
                        
                        // ì²˜ìŒ 10ê°œì™€ ë§ˆì§€ë§‰ 10ê°œë§Œ í‘œì‹œ
                        const preview = [...data.slice(0, 10), ...(data.length > 20 ? data.slice(-10) : [])];
                        
                        preview.forEach((item, idx) => {
                            if (idx === 10 && data.length > 20) {
                                html += '<tr><td colspan="4" style="text-align: center; color: #64748b;">... (ì¤‘ëµ) ...</td></tr>';
                            }
                            html += `<tr>
                                <td>${item.age}</td>
                                <td>${item.L}</td>
                                <td>${item.M}</td>
                                <td>${item.S}</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                    }
                });
            });

            resultDiv.innerHTML = html;

            // JSON í‘œì‹œ
            document.getElementById('jsonOutput').style.display = 'block';
            document.getElementById('jsonPreview').textContent = JSON.stringify(finalJSON, null, 2);
        }

        function downloadJSON() {
            if (!finalJSON) return;

            const blob = new Blob([JSON.stringify(finalJSON, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'korea_growth_standard.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyJSON() {
            if (!finalJSON) return;

            const jsonText = JSON.stringify(finalJSON, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                alert('âœ… JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\ndata/korea_growth_standard.json íŒŒì¼ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            });
        }
    </script>
</body>
</html>
