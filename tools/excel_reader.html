<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ í‘œì¤€ ì„±ì¥ë„í‘œ ë°ì´í„° ì¶”ì¶œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        select, button {
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            background: #3b82f6;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #2563eb;
        }
        #output {
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        .sheet-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .sheet-btn {
            padding: 8px 16px;
            background: #e2e8f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .sheet-btn.active {
            background: #3b82f6;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .info {
            background: #dbeafe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š í•œêµ­ í‘œì¤€ ì„±ì¥ë„í‘œ ë°ì´í„° ì¶”ì¶œ ë„êµ¬</h1>
        
        <div class="info">
            âœ… ì—‘ì…€ íŒŒì¼ì´ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.
        </div>

        <div class="controls">
            <button onclick="loadExcel()">ğŸ“‚ ì—‘ì…€ íŒŒì¼ ë¡œë“œ</button>
            <button onclick="extractAllData()">ğŸ”„ ëª¨ë“  ë°ì´í„° ì¶”ì¶œ (JSON)</button>
            <button onclick="downloadJSON()">ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div id="sheetList" class="sheet-list"></div>
        <div id="output"></div>
    </div>

    <script>
        let workbook = null;
        let extractedData = null;

        async function loadExcel() {
            try {
                const response = await fetch('../data/korea_growth_chart.xls');
                const arrayBuffer = await response.arrayBuffer();
                workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('ì›Œí¬ë¶ ë¡œë“œ ì™„ë£Œ:', workbook.SheetNames);
                
                displaySheetList();
                document.getElementById('output').textContent = 
                    `âœ… ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì„±ê³µ!\n\n` +
                    `ì´ ì‹œíŠ¸ ìˆ˜: ${workbook.SheetNames.length}\n\n` +
                    `ì‹œíŠ¸ ëª©ë¡:\n${workbook.SheetNames.map((name, i) => `${i+1}. ${name}`).join('\n')}`;
                
            } catch (error) {
                console.error('ì—‘ì…€ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('output').textContent = 'âŒ ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + error.message;
            }
        }

        function displaySheetList() {
            const container = document.getElementById('sheetList');
            container.innerHTML = workbook.SheetNames.map((name, index) => 
                `<button class="sheet-btn" onclick="showSheet(${index})">${name}</button>`
            ).join('');
        }

        function showSheet(index) {
            const sheetName = workbook.SheetNames[index];
            const sheet = workbook.Sheets[sheetName];
            
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.sheet-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            // JSONìœ¼ë¡œ ë³€í™˜
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // í…Œì´ë¸”ë¡œ í‘œì‹œ
            let html = `<h3>ğŸ“„ ì‹œíŠ¸: ${sheetName}</h3>`;
            html += `<p>ì´ ${jsonData.length}í–‰</p>`;
            html += '<table><thead><tr>';
            
            // í—¤ë”
            if (jsonData.length > 0) {
                jsonData[0].forEach(cell => {
                    html += `<th>${cell || ''}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // ë°ì´í„° (ìµœëŒ€ 100í–‰ë§Œ í‘œì‹œ)
                for (let i = 1; i < Math.min(jsonData.length, 101); i++) {
                    html += '<tr>';
                    jsonData[i].forEach(cell => {
                        html += `<td>${cell !== undefined ? cell : ''}</td>`;
                    });
                    html += '</tr>';
                }
                html += '</tbody></table>';
            }
            
            document.getElementById('output').innerHTML = html;
        }

        function extractAllData() {
            if (!workbook) {
                alert('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”!');
                return;
            }

            extractedData = {
                male: {
                    height: [],
                    weight: []
                },
                female: {
                    height: [],
                    weight: []
                }
            };

            // ê° ì‹œíŠ¸ ë¶„ì„
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                console.log(`\n=== ì‹œíŠ¸: ${sheetName} ===`);
                console.log('ì²« 10í–‰:', data.slice(0, 10));
                
                // ì‹œíŠ¸ ì´ë¦„ìœ¼ë¡œ ì„±ë³„ê³¼ ìœ í˜• íŒë‹¨
                const nameLower = sheetName.toLowerCase();
                let gender = null;
                let type = null;
                
                if (nameLower.includes('ë‚¨') || nameLower.includes('boy')) {
                    gender = 'male';
                } else if (nameLower.includes('ì—¬') || nameLower.includes('girl')) {
                    gender = 'female';
                }
                
                if (nameLower.includes('í‚¤') || nameLower.includes('ì‹ ì¥') || nameLower.includes('height')) {
                    type = 'height';
                } else if (nameLower.includes('ëª¸ë¬´ê²Œ') || nameLower.includes('ì²´ì¤‘') || nameLower.includes('weight')) {
                    type = 'weight';
                }
                
                console.log('ê°ì§€ëœ ìœ í˜•:', gender, type);
                
                if (gender && type && data.length > 1) {
                    // ë°ì´í„° ì¶”ì¶œ ë¡œì§ (í—¤ë”ë¥¼ ì°¾ì•„ì„œ L, M, S ê°’ ì¶”ì¶œ)
                    const headerRow = findHeaderRow(data);
                    if (headerRow !== -1) {
                        const headers = data[headerRow];
                        const ageCol = findColumn(headers, ['age', 'ë‚˜ì´', 'ì—°ë ¹', 'ì›”ë ¹']);
                        const lCol = findColumn(headers, ['L']);
                        const mCol = findColumn(headers, ['M']);
                        const sCol = findColumn(headers, ['S']);
                        
                        console.log('ì»¬ëŸ¼ ìœ„ì¹˜:', { ageCol, lCol, mCol, sCol });
                        
                        if (ageCol !== -1 && lCol !== -1 && mCol !== -1 && sCol !== -1) {
                            for (let i = headerRow + 1; i < data.length; i++) {
                                const row = data[i];
                                if (row[ageCol] !== undefined && row[lCol] !== undefined) {
                                    extractedData[gender][type].push({
                                        age: parseFloat(row[ageCol]),
                                        L: parseFloat(row[lCol]),
                                        M: parseFloat(row[mCol]),
                                        S: parseFloat(row[sCol])
                                    });
                                }
                            }
                        }
                    }
                }
            });

            console.log('ì¶”ì¶œëœ ë°ì´í„°:', extractedData);
            
            // ê²°ê³¼ í‘œì‹œ
            let output = 'âœ… ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ!\n\n';
            output += `ë‚¨ì•„ í‚¤ ë°ì´í„°: ${extractedData.male.height.length}ê°œ\n`;
            output += `ë‚¨ì•„ ì²´ì¤‘ ë°ì´í„°: ${extractedData.male.weight.length}ê°œ\n`;
            output += `ì—¬ì•„ í‚¤ ë°ì´í„°: ${extractedData.female.height.length}ê°œ\n`;
            output += `ì—¬ì•„ ì²´ì¤‘ ë°ì´í„°: ${extractedData.female.weight.length}ê°œ\n\n`;
            output += 'ìƒ˜í”Œ ë°ì´í„° (ë‚¨ì•„ í‚¤ ì²˜ìŒ 5ê°œ):\n';
            output += JSON.stringify(extractedData.male.height.slice(0, 5), null, 2);
            
            document.getElementById('output').textContent = output;
        }

        function findHeaderRow(data) {
            for (let i = 0; i < Math.min(data.length, 20); i++) {
                const row = data[i];
                if (row && row.some(cell => 
                    cell && (cell.toString().includes('L') || 
                            cell.toString().includes('M') || 
                            cell.toString().includes('S') ||
                            cell.toString().toLowerCase().includes('age'))
                )) {
                    return i;
                }
            }
            return -1;
        }

        function findColumn(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const cell = headers[i];
                if (cell) {
                    const cellStr = cell.toString().toLowerCase();
                    if (keywords.some(keyword => cellStr.includes(keyword.toLowerCase()))) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function downloadJSON() {
            if (!extractedData) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”!');
                return;
            }

            const dataStr = JSON.stringify(extractedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'korea_growth_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadExcel();
        });
    </script>
</body>
</html>
