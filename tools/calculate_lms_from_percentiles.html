<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±ë¶„ìœ„ í…Œì´ë¸”ì—ì„œ LMS ê°’ ê³„ì‚°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #64748b;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }
        .upload-area.dragover {
            border-color: #2563eb;
            background: #eff6ff;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        #result {
            margin-top: 30px;
        }
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .data-preview {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f1f5f9;
            font-weight: 600;
            color: #334155;
        }
        .formula {
            font-family: 'Courier New', monospace;
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
        .success {
            color: #10b981;
        }
        .error {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ë°±ë¶„ìœ„ í…Œì´ë¸”ì—ì„œ LMS ê°’ ê³„ì‚°</h1>
        <p class="subtitle">ì—‘ì…€ íŒŒì¼ì˜ ë°±ë¶„ìœ„ í…Œì´ë¸”ì„ ë¶„ì„í•˜ì—¬ ì •í™•í•œ LMS ê°’ì„ ì—­ê³„ì‚°í•©ë‹ˆë‹¤</p>

        <div class="info-box">
            <strong>ğŸ’¡ LMS ë°©ë²•ì´ë€?</strong><br>
            Lambda-Mu-Sigma ë°©ë²•ìœ¼ë¡œ ì„±ì¥ ê³¡ì„ ì„ í‘œí˜„í•©ë‹ˆë‹¤:<br>
            â€¢ <span class="formula">L</span> (Lambda): Box-Cox ë³€í™˜ ê³„ìˆ˜ (ì™œë„ ì¡°ì •)<br>
            â€¢ <span class="formula">M</span> (Mu): ì¤‘ì•™ê°’ (50th percentile)<br>
            â€¢ <span class="formula">S</span> (Sigma): ë³€ë™ê³„ìˆ˜ (í‘œì¤€í¸ì°¨ / í‰ê· )<br><br>
            <strong>ì—­ê³„ì‚° ê³µì‹:</strong><br>
            ë°±ë¶„ìœ„ â†’ Z-score â†’ <span class="formula">Height = M Ã— (1 + L Ã— S Ã— Z)^(1/L)</span>
        </div>

        <div class="upload-area" id="uploadArea">
            <p style="font-size: 18px; margin-bottom: 10px;">ğŸ“ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
            <p style="color: #64748b; font-size: 14px;">ì„±ì¥ë„í‘œ+ë°ì´í„°+í…Œì´ë¸”.xls</p>
            <input type="file" id="fileInput" accept=".xls,.xlsx" style="display: none;">
        </div>

        <div id="sheetSelector" style="display: none; margin-bottom: 20px;">
            <label style="font-weight: 600; display: block; margin-bottom: 8px;">ì‹œíŠ¸ ì„ íƒ:</label>
            <select id="sheetSelect" style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%;">
            </select>
        </div>

        <button id="analyzeBtn" disabled>ğŸ” LMS ê°’ ê³„ì‚°í•˜ê¸°</button>
        <button id="downloadBtn" style="display: none; background: #10b981;">ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ</button>

        <div id="result"></div>
    </div>

    <script>
        let workbook = null;
        let calculatedData = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const sheetSelector = document.getElementById('sheetSelector');
        const sheetSelect = document.getElementById('sheetSelect');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resultDiv = document.getElementById('result');

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    // ì‹œíŠ¸ ëª©ë¡ í‘œì‹œ
                    sheetSelect.innerHTML = workbook.SheetNames.map(name => 
                        `<option value="${name}">${name}</option>`
                    ).join('');
                    
                    sheetSelector.style.display = 'block';
                    analyzeBtn.disabled = false;
                    
                    resultDiv.innerHTML = `<p class="success">âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ! (${workbook.SheetNames.length}ê°œ ì‹œíŠ¸)</p>`;
                } catch (error) {
                    resultDiv.innerHTML = `<p class="error">âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${error.message}</p>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        analyzeBtn.addEventListener('click', calculateLMS);

        function calculateLMS() {
            const sheetName = sheetSelect.value;
            const sheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            resultDiv.innerHTML = '<p>ğŸ”„ ë¶„ì„ ì¤‘...</p>';

            // ë°ì´í„° êµ¬ì¡° ë¶„ì„
            const preview = analyzeSheetStructure(data, sheetName);
            
            // LMS ê³„ì‚°
            const lmsResults = calculateLMSFromPercentiles(data, sheetName);

            // ê²°ê³¼ í‘œì‹œ
            displayResults(preview, lmsResults, sheetName);
        }

        function analyzeSheetStructure(data, sheetName) {
            let html = '<div class="data-preview">';
            html += `<h3>ğŸ“‹ ì‹œíŠ¸ êµ¬ì¡°: ${sheetName}</h3>`;
            html += '<table><thead><tr>';
            
            // í—¤ë” (ì²« 5ê°œ ì—´ë§Œ)
            const header = data[0] || [];
            header.slice(0, 10).forEach(cell => {
                html += `<th>${cell || ''}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // ë°ì´í„° (ì²˜ìŒ 10í–‰ë§Œ)
            data.slice(1, 11).forEach(row => {
                html += '<tr>';
                row.slice(0, 10).forEach(cell => {
                    html += `<td>${cell !== undefined ? cell : ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += `<p style="color: #64748b; margin-top: 10px;">ì´ ${data.length}í–‰ Ã— ${header.length}ì—´</p>`;
            html += '</div>';
            
            return html;
        }

        function calculateLMSFromPercentiles(data, sheetName) {
            // í—¤ë”ì—ì„œ ë°±ë¶„ìœ„ ì»¬ëŸ¼ ì°¾ê¸°
            const header = data[0] || [];
            
            // ë‚˜ì´/ì—°ë ¹ ì»¬ëŸ¼ ì°¾ê¸°
            const ageColIndex = header.findIndex(h => 
                h && (h.toString().includes('ë‚˜ì´') || h.toString().includes('Age') || h.toString().includes('ì—°ë ¹') || h.toString().includes('ì›”'))
            );

            // 50th percentile (ì¤‘ì•™ê°’) ì»¬ëŸ¼ ì°¾ê¸°
            const p50Index = header.findIndex(h => 
                h && (h.toString().includes('50') || h.toString() === '50th')
            );

            // 5th, 95th, 75th ë“± ë‹¤ë¥¸ ë°±ë¶„ìœ„ ì°¾ê¸°
            const p5Index = header.findIndex(h => h && (h.toString().includes('5') || h.toString() === '5th'));
            const p95Index = header.findIndex(h => h && (h.toString().includes('95') || h.toString() === '95th'));
            const p75Index = header.findIndex(h => h && (h.toString().includes('75') || h.toString() === '75th'));

            console.log('Found columns:', { ageColIndex, p50Index, p5Index, p95Index, p75Index });

            if (ageColIndex === -1 || p50Index === -1) {
                return { error: 'ë‚˜ì´ ë˜ëŠ” 50th ë°±ë¶„ìœ„ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
            }

            const results = [];

            // ë°ì´í„° í–‰ ë¶„ì„
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const age = parseFloat(row[ageColIndex]);
                const p50 = parseFloat(row[p50Index]);

                if (isNaN(age) || isNaN(p50)) continue;

                // M ê°’ (50th percentile)
                const M = p50;

                // S ê°’ ê³„ì‚° (75th ë˜ëŠ” 95th ì‚¬ìš©)
                let S = 0.04; // ê¸°ë³¸ê°’
                let L = 1; // ëŒ€ë¶€ë¶„ì˜ ê²½ìš° L=1

                if (p75Index !== -1 && row[p75Index]) {
                    const p75 = parseFloat(row[p75Index]);
                    if (!isNaN(p75)) {
                        // Z(75%) â‰ˆ 0.674
                        // p75 = M Ã— (1 + L Ã— S Ã— 0.674)^(1/L)
                        // S = (p75/M - 1) / (L Ã— 0.674) (when L=1)
                        S = (p75 / M - 1) / 0.674;
                    }
                } else if (p95Index !== -1 && row[p95Index]) {
                    const p95 = parseFloat(row[p95Index]);
                    if (!isNaN(p95)) {
                        // Z(95%) â‰ˆ 1.645
                        S = (p95 / M - 1) / 1.645;
                    }
                }

                // S ê°’ ë³´ì • (ë„ˆë¬´ í¬ê±°ë‚˜ ì‘ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                if (S < 0.01 || S > 0.2 || isNaN(S)) {
                    S = 0.04;
                }

                results.push({
                    age: Math.round(age * 10) / 10,
                    L: Math.round(L * 10000) / 10000,
                    M: Math.round(M * 10) / 10,
                    S: Math.round(S * 10000) / 10000
                });
            }

            return { data: results, sheetName };
        }

        function displayResults(preview, lmsResults, sheetName) {
            let html = preview;

            if (lmsResults.error) {
                html += `<div class="info-box" style="border-color: #ef4444; background: #fef2f2;">
                    <strong class="error">âŒ ì˜¤ë¥˜:</strong> ${lmsResults.error}
                </div>`;
                resultDiv.innerHTML = html;
                return;
            }

            html += '<div class="info-box" style="border-color: #10b981; background: #f0fdf4;">';
            html += `<strong class="success">âœ… LMS ê³„ì‚° ì™„ë£Œ!</strong><br>`;
            html += `ì´ ${lmsResults.data.length}ê°œ ì—°ë ¹ëŒ€ì˜ LMS ê°’ì„ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.`;
            html += '</div>';

            html += '<div class="data-preview">';
            html += '<h3>ğŸ“Š ê³„ì‚°ëœ LMS ê°’</h3>';
            html += '<table><thead><tr><th>ë‚˜ì´</th><th>L</th><th>M (50th)</th><th>S</th></tr></thead><tbody>';
            
            lmsResults.data.forEach(item => {
                html += `<tr>
                    <td>${item.age}</td>
                    <td>${item.L}</td>
                    <td>${item.M}</td>
                    <td>${item.S}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';

            resultDiv.innerHTML = html;
            calculatedData = lmsResults;
            downloadBtn.style.display = 'inline-block';
        }

        downloadBtn.addEventListener('click', () => {
            if (!calculatedData) return;

            const json = {
                metadata: {
                    source: "ëŒ€í•œì†Œì•„ê³¼í•™íšŒ 2017 í•œêµ­ ì†Œì•„ì²­ì†Œë…„ ì„±ì¥ë„í‘œ",
                    sheet: calculatedData.sheetName,
                    method: "LMS (ë°±ë¶„ìœ„ í…Œì´ë¸”ì—ì„œ ì—­ê³„ì‚°)",
                    calculated: new Date().toISOString(),
                    note: "L=1 ê°€ì •, SëŠ” 75th ë˜ëŠ” 95th percentileì—ì„œ ì—­ì‚°"
                },
                data: calculatedData.data
            };

            const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lms_${calculatedData.sheetName.replace(/[^a-zA-Z0-9]/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
